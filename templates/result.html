<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Result: {{ title }}</title>
    <style>
      body {
        font-family: -apple-system,
          BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue",
          Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
      }
      h1,
      h2 {
        color: #111;
        border-bottom: 2px solid #eee;
        padding-bottom: 0.5rem;
      }

      /* ▼▼▼ MODIFIED <pre> STYLE FOR BETTER READABILITY ▼▼▼ */
      pre {
        background: #f4f4f4;
        border: 1px solid #ddd;
        padding: 1.5rem; /* Increased padding */
        white-space: pre-wrap;
        word-wrap: break-word;
        border-radius: 8px; /* Slightly more rounded corners */

        /* The key improvements for readability */
        line-height: 1.7; /* Adds vertical space between lines */
        text-align: justify; /* Aligns text neatly on both sides */
      }
      /* ▲▲▲ END OF MODIFIED STYLE ▲▲▲ */

      .summary-box {
        border: 1px solid #cce5ff;
        background: #f0f8ff;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
      }
      a {
        color: #007bff;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }

      /* Chat Interface Styles */
      #chat-container {
        margin-top: 3rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        overflow: hidden;
      }
      #chat-header {
        background-color: #f7f7f7;
        padding: 0.75rem 1.25rem;
        font-weight: bold;
        border-bottom: 1px solid #ccc;
      }
      #chat-window {
        height: 400px;
        overflow-y: auto;
        padding: 1rem;
        background: #fff;
      }
      .chat-message {
        margin-bottom: 1rem;
      }
      .chat-message.user {
        text-align: right;
      }
      .chat-bubble {
        display: inline-block;
        padding: 0.6rem 1rem;
        border-radius: 18px;
        max-width: 80%;
      }
      .chat-bubble.user {
        background-color: #007bff;
        color: white;
      }
      .chat-bubble.ai {
        background-color: #e9e9eb;
        color: #333;
        text-align: left;
      } /* Ensure AI text is left-aligned */
      .chat-bubble.typing {
        font-style: italic;
        color: #888;
      }
      #chat-input-form {
        display: flex;
        border-top: 1px solid #ccc;
      }
      #chat-input {
        flex-grow: 1;
        border: none;
        padding: 1rem;
        font-size: 1rem;
        outline: none;
      }
      #chat-send {
        background: #007bff;
        color: white;
        border: none;
        padding: 0 1.5rem;
        font-size: 1rem;
        cursor: pointer;
      }
      #chat-send:disabled {
        background: #5a9ee0;
      }
    </style>
  </head>
  <body>
    <p>
      <a href="{{ url_for('index') }}"
        >← Back to All Meetings</a
      >
    </p>
    <h1>{{ title }}</h1>

    <div class="summary-box">
      <!-- The summary text will also benefit from the new <pre> style! -->
      <h2>
        Summary (Generated by {{
        provider | capitalize }})
      </h2>
      <pre>{{ summary }}</pre>
    </div>

    <div id="chat-container">
      <div id="chat-header">
        Ask follow-up questions with {{
        provider | capitalize }}
      </div>
      <div id="chat-window">
        <div class="chat-message ai">
          <div class="chat-bubble ai">
            Hello! Ask me anything about
            the transcript.
          </div>
        </div>
      </div>
      <form id="chat-input-form">
        <input
          type="text"
          id="chat-input"
          placeholder="Type your question here..."
          autocomplete="off"
        />
        <button
          type="submit"
          id="chat-send"
        >
          Send
        </button>
      </form>
    </div>

    <h2>Full Transcript</h2>
    <pre>{{ transcript }}</pre>

    <script>
      const chatForm =
        document.getElementById(
          "chat-input-form"
        );
      const chatInput =
        document.getElementById(
          "chat-input"
        );
      const chatSend =
        document.getElementById(
          "chat-send"
        );
      const chatWindow =
        document.getElementById(
          "chat-window"
        );

      const jobId = "{{ id }}";
      const aiProvider =
        "{{ provider | default('gemini', true) }}";

      chatForm.addEventListener(
        "submit",
        async function (event) {
          event.preventDefault();
          const userMessage =
            chatInput.value.trim();
          if (!userMessage) return;

          addMessageToWindow(
            userMessage,
            "user"
          );
          chatInput.value = "";
          chatSend.disabled = true;

          const typingIndicator =
            addMessageToWindow(
              "AI is typing...",
              "ai",
              true
            );

          try {
            const response =
              await fetch(
                `/chat/${jobId}`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type":
                      "application/json"
                  },
                  body: JSON.stringify({
                    message:
                      userMessage,
                    provider: aiProvider
                  })
                }
              );

            const data =
              await response.json();

            chatWindow.removeChild(
              typingIndicator
            );
            addMessageToWindow(
              data.reply ||
                data.error ||
                "An error occurred.",
              "ai"
            );
          } catch (error) {
            console.error(
              "Fetch Error:",
              error
            );
            chatWindow.removeChild(
              typingIndicator
            );
            addMessageToWindow(
              "Could not connect to the server. Check the console for details.",
              "ai"
            );
          } finally {
            chatSend.disabled = false;
          }
        }
      );

      function addMessageToWindow(
        message,
        sender,
        isTyping = false
      ) {
        const messageWrapper =
          document.createElement("div");
        messageWrapper.classList.add(
          "chat-message",
          sender
        );
        const bubble =
          document.createElement("div");
        bubble.classList.add(
          "chat-bubble",
          sender
        );
        if (isTyping)
          bubble.classList.add(
            "typing"
          );
        bubble.textContent = message;
        messageWrapper.appendChild(
          bubble
        );
        chatWindow.appendChild(
          messageWrapper
        );
        chatWindow.scrollTop =
          chatWindow.scrollHeight;
        return messageWrapper;
      }
    </script>
  </body>
</html>
